import streamlit as st
import pandas as pd
import plotly.express as px
from streamlit_option_menu import option_menu
# from extra_streamlit_components import TabBar, Tab, Card  <-- ì´ ë¶€ë¶„ì„ ì‚­ì œí•©ë‹ˆë‹¤!
from streamlit_extras.colored_header import colored_header
from streamlit_extras.app_logo import add_logo
from streamlit_extras.let_it_rain import rain

# ----------------- 1. ì„¤ì • ë° ë°ì´í„° ë¡œë“œ -----------------
# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸŒŸ MBTI ì„¸ê³„ê´€ íƒí—˜ê¸° ğŸŒ",
    page_icon="ğŸ”",
    layout="wide",
    initial_sidebar_state="expanded"
)

# íŒŒì¼ ë¡œë“œ (ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ íŒŒì¼ ì´ë¦„ ì‚¬ìš©)
FILE_PATH = "countriesMBTI_16types.csv"
try:
    df = pd.read_csv(FILE_PATH)
    # ì²« ë²ˆì§¸ ì»¬ëŸ¼ ì´ë¦„ì„ 'Country'ë¡œ í™•ì‹¤í•˜ê²Œ ì„¤ì •
    if df.columns[0] != 'Country':
        df = df.rename(columns={df.columns[0]: 'Country'})
    
    # MBTI ìœ í˜• ë¦¬ìŠ¤íŠ¸ ìƒì„± (Country ì»¬ëŸ¼ ì œì™¸)
    MBTI_TYPES = df.columns.tolist()[1:]
except FileNotFoundError:
    st.error(f"ì²¨ë¶€ íŒŒì¼ '{FILE_PATH}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    st.stop()
except Exception as e:
    st.error(f"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
    st.stop()


# ----------------- 2. MBTI ìœ í˜•ë³„ ì„¤ëª… ë° ë©˜íŠ¸ -----------------

MBTI_INFO = {
    "INTJ": {"icon": "ğŸ’¡", "desc": "ìš©ì˜ì£¼ë„í•œ ì „ëµê°€", "ment": "**INTJ**! ë¶„ì„ì ì´ê³  ë…ë¦½ì ì¸ ë‹¹ì‹ ì€ **ì„¸ê³„ë¥¼ ì„¤ê³„í•˜ëŠ” ê±´ì¶•ê°€**ì™€ ê°™ìŠµë‹ˆë‹¤. ë¯¸ë˜ë¥¼ í–¥í•œ ëª…í™•í•œ ë¹„ì „ìœ¼ë¡œ ëª©í‘œë¥¼ ë‹¬ì„±í•  ëŠ¥ë ¥ì´ ìˆì–´ìš”! ğŸš€"},
    "INTP": {"icon": "ğŸ§ ", "desc": "ë…¼ë¦¬ì ì¸ ì‚¬ìƒ‰ê°€", "ment": "**INTP**! ì§€ì ì¸ í˜¸ê¸°ì‹¬ì´ ë„˜ì¹˜ëŠ” ë‹¹ì‹ ì€ **ì•„ì´ë””ì–´ì˜ ëŠì„ì—†ëŠ” ìƒ˜**ì…ë‹ˆë‹¤. ë³µì¡í•œ ë¬¸ì œë¥¼ í’€ì–´ë‚´ëŠ” ì¦ê±°ì›€ì„ ì•„ëŠ” ì§„ì •í•œ íƒí—˜ê°€! ğŸŒŒ"},
    "ENTJ": {"icon": "ğŸ‘‘", "desc": "ëŒ€ë‹´í•œ í†µì†”ì", "ment": "**ENTJ**! ì¹´ë¦¬ìŠ¤ë§ˆ ë„˜ì¹˜ëŠ” ë¦¬ë”ì‹­ì˜ ì†Œìœ ì! **ëª©í‘œë¥¼ í–¥í•´ ê±°ì¹¨ì—†ì´ ë‚˜ì•„ê°€ëŠ” ì¥êµ°**ì²˜ëŸ¼ íŒ€ì„ ì´ëŒì–´ ë¹„ì „ì„ í˜„ì‹¤ë¡œ ë§Œë“¤ ëŠ¥ë ¥ì´ ìˆìŠµë‹ˆë‹¤! ğŸŒŸ"},
    "ENTP": {"icon": "ğŸŒªï¸", "desc": "ëœ¨ê±°ìš´ ë…¼ìŸì„ ì¦ê¸°ëŠ” ë³€ë¡ ê°€", "ment": "**ENTP**! ê¸°ë°œí•œ ì•„ì´ë””ì–´ì™€ ë›°ì–´ë‚œ ì–¸ë³€ì˜ ì†Œìœ ì! **ì„¸ìƒì˜ ê³ ì •ê´€ë…ì„ ê¹¨ë¶€ìˆ˜ëŠ” í˜ì‹ ê°€**ì˜ ì—­í• ì„ ë©‹ì§€ê²Œ í•´ë‚¼ ê±°ì˜ˆìš”! âœ¨"},
    "INFJ": {"icon": "ğŸ˜‡", "desc": "ì„ ì˜ì˜ ì˜¹í˜¸ì", "ment": "**INFJ**! ê¹Šì€ í†µì°°ë ¥ê³¼ ë”°ëœ»í•œ ë§ˆìŒì„ ê°€ì§„ ë‹¹ì‹ ì€ **ì„¸ìƒì˜ ë“±ë¶ˆ**ê³¼ ê°™ìŠµë‹ˆë‹¤. ì‚¬ëŒë“¤ì˜ ì„±ì¥ì„ ë•ê³  ì˜ë¯¸ìˆëŠ” ë³€í™”ë¥¼ ë§Œë“œëŠ” ì„ í•œ ì˜í–¥ë ¥! ğŸ’–"},
    "INFP": {"icon": "ğŸ¦„", "desc": "ì—´ì •ì ì¸ ì¤‘ì¬ì", "ment": "**INFP**! ì´ìƒì„ ì¶”êµ¬í•˜ê³  ì§„ì •í•œ ê°€ì¹˜ë¥¼ ì¤‘ìš”ì‹œí•˜ëŠ” ë‹¹ì‹ ì€ **ì˜í˜¼ì˜ ì‹œì¸**ì…ë‹ˆë‹¤. ë‚´ë©´ì˜ ê¹Šì€ ìš¸ë¦¼ìœ¼ë¡œ ì„¸ìƒì„ ë” ì•„ë¦„ë‹µê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”! ğŸŒ¿"},
    "ENFJ": {"icon": "ğŸ«‚", "desc": "ì •ì˜ë¡œìš´ ì‚¬íšŒ ìš´ë™ê°€", "ment": "**ENFJ**! ì‚¬ëŒë“¤ì—ê²Œ ì˜ê°ì„ ì£¼ê³  ë™ê¸°ë¥¼ ë¶€ì—¬í•˜ëŠ” **íƒ€ê³ ë‚œ ë©˜í† **ì…ë‹ˆë‹¤. ë›°ì–´ë‚œ ê³µê° ëŠ¥ë ¥ìœ¼ë¡œ ëª¨ë‘ê°€ í•¨ê»˜ ì„±ì¥í•˜ëŠ” ì„¸ìƒì„ ê¿ˆê¿‰ë‹ˆë‹¤! ğŸŒˆ"},
    "ENFP": {"icon": "â˜€ï¸", "desc": "ì¬ê¸°ë°œë„í•œ í™œë™ê°€", "ment": "**ENFP**! ì—ë„ˆì§€ê°€ ë„˜ì¹˜ê³  ì°½ì˜ì ì¸ ë‹¹ì‹ ì€ **ì‚¶ì„ ì¶•ì œë¡œ ë§Œë“œëŠ” ì£¼ì¸ê³µ**ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì„ ëŠì„ì—†ì´ íƒìƒ‰í•˜ëŠ” ììœ ë¡œìš´ ì˜í˜¼! ğŸ‰"},
    "ISTJ": {"icon": "ğŸ“", "desc": "ì²­ë ´ê²°ë°±í•œ ë…¼ë¦¬ì£¼ì˜ì", "ment": "**ISTJ**! í˜„ì‹¤ì ì´ê³  ì±…ì„ê°ì´ ê°•í•œ ë‹¹ì‹ ì€ **ì‚¬íšŒì˜ êµ³ê±´í•œ ê¸°ë‘¥**ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì •í™•ì„±ê³¼ í—Œì‹ ì€ ì–¸ì œë‚˜ ë¯¿ìŒì„ ì¤ë‹ˆë‹¤! ğŸ›ï¸"},
    "ISFJ": {"icon": "ğŸ›¡ï¸", "desc": "ìš©ê°í•œ ìˆ˜í˜¸ì", "ment": "**ISFJ**! íƒ€ì¸ì˜ í•„ìš”ë¥¼ ë†“ì¹˜ì§€ ì•ŠëŠ” ë”°ëœ»í•œ ë‹¹ì‹ ì€ **ê°€ì¥ ë“ ë“ í•œ ì§€ì›êµ°**ì…ë‹ˆë‹¤. ì¡°ìš©í•˜ì§€ë§Œ ê°•í•œ í—Œì‹ ìœ¼ë¡œ ì£¼ë³€ì„ ì§€ì¼œì¤ë‹ˆë‹¤! ğŸ¡"},
    "ESTJ": {"icon": "ğŸ’¼", "desc": "ì—„ê²©í•œ ê´€ë¦¬ì", "ment": "**ESTJ**! ëª…í™•í•œ ê·œì¹™ê³¼ íš¨ìœ¨ì„±ì„ ì¤‘ì‹œí•˜ëŠ” ë‹¹ì‹ ì€ **ì¡°ì§ì˜ ì—”ì§„**ì…ë‹ˆë‹¤. ì§ˆì„œë¥¼ í™•ë¦½í•˜ê³  ê³„íšì„ ì™„ë²½í•˜ê²Œ ì‹¤í–‰í•´ë‚´ëŠ” ëŠ¥ë ¥ì! ğŸ¯"},
    "ESFJ": {"icon": "ğŸ¥³", "desc": "ì‚¬êµì ì¸ ì™¸êµê´€", "ment": "**ESFJ**! ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„ë¥¼ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ” ë‹¹ì‹ ì€ **ëª¨ë‘ë¥¼ í•˜ë‚˜ë¡œ ì—®ëŠ” ì ‘ì°©ì œ**ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì¹œí™”ë ¥ì€ ìµœê³ ì˜ ê°•ì ì…ë‹ˆë‹¤! ğŸˆ"},
    "ISTP": {"icon": "ğŸ”§", "desc": "ë§ŒëŠ¥ ì¬ì£¼ê¾¼", "ment": "**ISTP**! ì†ìœ¼ë¡œ ë§Œë“¤ê³  ì§ì ‘ ê²½í—˜í•˜ëŠ” ê²ƒì„ ì¦ê¸°ëŠ” ë‹¹ì‹ ì€ **í˜„ì‹¤ ë¬¸ì œ í•´ê²°ì‚¬**ì…ë‹ˆë‹¤. ì–´ë–¤ ë„êµ¬ë“  ëŠ¥ìˆ™í•˜ê²Œ ë‹¤ë£¨ëŠ” ë©‹ì§„ ì¬ì£¼ê¾¼! ğŸ› ï¸"},
    "ISFP": {"icon": "ğŸŒ¸", "desc": "í˜¸ê¸°ì‹¬ ë§ì€ ì˜ˆìˆ ê°€", "ment": "**ISFP**! ì•„ë¦„ë‹¤ì›€ì„ ì¶”êµ¬í•˜ê³  ìˆœê°„ì„ ì¦ê¸°ëŠ” ë‹¹ì‹ ì€ **ììœ ë¡œìš´ ì˜ˆìˆ í˜¼**ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ê°ê°ì ì¸ í‘œí˜„ì€ ì„¸ìƒì„ í’ìš”ë¡­ê²Œ ë§Œë“­ë‹ˆë‹¤! ğŸ¨"},
    "ESTP": {"icon": "ğŸï¸", "desc": "ëª¨í—˜ì„ ì¦ê¸°ëŠ” ì‚¬ì—…ê°€", "ment": "**ESTP**! ì—ë„ˆì§€ì™€ ìŠ¤ë¦´ì„ ì¦ê¸°ëŠ” ë‹¹ì‹ ì€ **í–‰ë™íŒŒì˜ ì •ì **ì…ë‹ˆë‹¤. ì§€ê¸ˆ ë‹¹ì¥, ëˆˆ ì•ì˜ ê¸°íšŒë¥¼ ë†“ì¹˜ì§€ ì•ŠëŠ” ë¯¼ì²©í•¨ì´ ë¹›ë‚©ë‹ˆë‹¤! ğŸ’¥"},
    "ESFP": {"icon": "ğŸ¤", "desc": "ììœ ë¡œìš´ ì—°ì˜ˆì¸", "ment": "**ESFP**! ì£¼ë³€ì„ ì¦ê²ê²Œ ë§Œë“¤ ì¤„ ì•„ëŠ” ë‹¹ì‹ ì€ **íŒŒí‹°ì˜ ì¤‘ì‹¬**ì…ë‹ˆë‹¤. ë°ê³  ê¸ì •ì ì¸ ì—ë„ˆì§€ë¡œ ëª¨ë‘ì—ê²Œ í™œë ¥ì„ ë¶ˆì–´ë„£ìŠµë‹ˆë‹¤! ğŸŒŸ"}
}

# ----------------- 3. ë©”ì¸ ì•± ë ˆì´ì•„ì›ƒ -----------------

# ì œëª© ë° ë¡œê³ 
st.markdown("<h1 style='text-align: center; color: #4B0082;'>ğŸŒŸ MBTI ì„¸ê³„ê´€ íƒí—˜ê¸° ğŸŒ</h1>", unsafe_allow_html=True)
st.markdown("---")

# ì‚¬ì´ë“œë°” ë©”ë‰´ (option_menu ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©)
with st.sidebar:
    st.subheader("ğŸ” MBTI ìœ í˜• ì„ íƒ")
    # 'ì„ íƒ ì•ˆí•¨' ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ ì´ˆê¸° ìƒíƒœë¥¼ í‘œí˜„
    selected_mbti = option_menu(
        menu_title=None,
        options=["ì„ íƒ ì•ˆí•¨"] + MBTI_TYPES,
        icons=["house"] + [MBTI_INFO[mbti]["icon"] for mbti in MBTI_TYPES],
        menu_icon="cast",
        default_index=0,
        styles={
            "container": {"padding": "5!important", "background-color": "#fafafa"},
            "icon": {"color": "orange", "font-size": "25px"},
            "nav-link": {"font-size": "16px", "text-align": "left", "margin": "0px", "--hover-color": "#eee"},
            "nav-link-selected": {"background-color": "#0288d1"},
        }
    )

# ----------------- 4. ì„ íƒ ê²°ê³¼ ì²˜ë¦¬ ë° í‘œì‹œ -----------------

if selected_mbti == "ì„ íƒ ì•ˆí•¨":
    # 4-1. ì´ˆê¸° ì ‘ì† ì‹œ ë©”ì‹œì§€ (ìš”ì²­ 4ë²ˆ)
    st.info("ğŸ‘‹ **í™˜ì˜í•©ë‹ˆë‹¤!** ì›¹ ì•± ì‚¬ìš©ì„ ìœ„í•´ ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ **MBTI ìœ í˜•**ì„ ì„ íƒí•´ì£¼ì„¸ìš”!")
    
    # ì‚ê¹Œë»”ì©í•¨ì„ ìœ„í•œ ë¹—ë°©ìš¸ íš¨ê³¼ (streamlit-extras)
    rain(
        emoji="âœ¨",
        font_size=50,
        falling_speed=5,
        animation_length="3s",
    )
    
    st.image("https://images.unsplash.com/photo-1518621736915-f5f4b00868d4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1740&q=80", 
             caption="ë‹¤ì–‘í•œ ìœ í˜•ì„ íƒí—˜í•´ ë³´ì„¸ìš”!", use_column_width=True)

else:
    # 4-2. MBTIê°€ ì„ íƒë˜ì—ˆì„ ë•Œ
    mbti_type = selected_mbti
    info = MBTI_INFO[mbti_type]
    
    # ì„ íƒëœ MBTIì— ëŒ€í•œ í—¤ë” (streamlit-extras)
    colored_header(
        label=f"{info['icon']} **{mbti_type}** : {info['desc']}",
        description=f"ì„ íƒí•˜ì‹  MBTI ìœ í˜• **{mbti_type}**ì— ëŒ€í•œ ë¶„ì„ ì •ë³´ì…ë‹ˆë‹¤.",
        color_name="blue-70",
    )

    col1, col2 = st.columns([1, 2])

    with col1:
        # MBTI ì„¤ëª… ë° ë©˜íŠ¸ (ìš”ì²­ 2, 3ë²ˆ)
        st.subheader(f"âœ¨ ë‹¹ì‹ ì„ ìœ„í•œ ë©˜íŠ¸")
        st.markdown(f"> {info['ment']}")
        
        # ê°„ë‹¨í•œ í†µê³„ ì •ë³´
        st.subheader(f"ğŸ“Š ì „ ì„¸ê³„ì  ë¹„ìœ¨")
        
        # í•´ë‹¹ MBTIì˜ í‰ê·  ë¹„ìœ¨ ê³„ì‚°
        avg_ratio = df[mbti_type].mean() * 100
        
        st.metric(
            label=f"{mbti_type} ì „ ì„¸ê³„ í‰ê·  ë¹„ìœ¨",
            value=f"{avg_ratio:.2f}%",
            delta=f"16ê°€ì§€ ìœ í˜• ì¤‘ í‰ê· ë³´ë‹¤ {'ë†’ìŠµë‹ˆë‹¤' if avg_ratio > 100/16 else 'ë‚®ìŠµë‹ˆë‹¤'}",
            delta_color="normal"
        )
        
    with col2:
        # 4-3. ë°ì´í„° ì‹œê°í™” (ìš”ì²­ 3ë²ˆ)
        st.subheader(f"ğŸŒ êµ­ê°€ë³„ {mbti_type} ë¹„ìœ¨ í†µê³„")
        
        # ì„ íƒëœ MBTI ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        top_n = 15
        plot_df = df.sort_values(by=mbti_type, ascending=False).head(top_n)
        
        # Plotlyë¥¼ ì‚¬ìš©í•œ ë§‰ëŒ€ ê·¸ë˜í”„ (ì¸í„°ë™í‹°ë¸Œ)
        fig = px.bar(
            plot_df,
            x=mbti_type,
            y='Country',
            orientation='h',
            title=f"MBTI {mbti_type} ìœ í˜• ë¹„ìœ¨ì´ ë†’ì€ ìƒìœ„ {top_n}ê°œ êµ­ê°€",
            labels={mbti_type: f"{mbti_type} ë¹„ìœ¨", "Country": "êµ­ê°€"},
            color=mbti_type,
            color_continuous_scale=px.colors.sequential.Viridis,
            height=600
        )
        
        # ë ˆì´ì•„ì›ƒ ê°œì„ 
        fig.update_layout(
            xaxis_tickformat=".2%",
            yaxis={'categoryorder':'total ascending'}
        )

        st.plotly_chart(fig, use_container_width=True)

    st.markdown("---")
    st.caption(f"**ë°ì´í„° ì¶œì²˜:** ì²¨ë¶€í•˜ì‹  `{FILE_PATH}` íŒŒì¼ ê¸°ë°˜")


# ----------------- 5. ì¶”ê°€ ì •ë³´ í‘œì‹œ -----------------
with st.expander("ğŸ› ï¸ ì‚¬ìš©ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡"):
    st.write("""
    ì´ ì•±ì€ ì•„ë˜ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤:
    - **`streamlit`**: ì›¹ ì•±ì˜ ê¸°ë³¸ í”„ë ˆì„ì›Œí¬
    - **`pandas`**: ë°ì´í„° ì²˜ë¦¬ ë° ë¶„ì„
    - **`plotly`**: ë©‹ì§„ ì¸í„°ë™í‹°ë¸Œ ë°ì´í„° ì‹œê°í™”
    - **`streamlit-option-menu`**: ì‚¬ì´ë“œë°”ì— ê¹”ë”í•œ ë©”ë‰´ êµ¬í˜„
    - **`streamlit-extras`**: ì¶”ê°€ì ì¸ UI/UX ê°œì„  ê¸°ëŠ¥ (í—¤ë”, ì´ëª¨ì§€ ë¹„, ë¡œê³  ë“±)
    """)
